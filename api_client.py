import json
import logging
import asyncio
import re
import time

from async_lru import alru_cache
from openai import AsyncOpenAI
from core import settings
_ai_cache: dict[tuple[int, str], tuple[float, dict]] = {}
CACHE_TTL = 3600  # 1 —á–∞—Å

client = AsyncOpenAI(api_key=settings.api_token, base_url=settings.api_url)


SYSTEM_PROMPT = """
–¢—ã ‚Äî AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –≤ Telegram-–±–æ—Ç–µ –º–∞–≥–∞–∑–∏–Ω–∞ —Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π. –ì–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–æ–≤–µ—Å—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –¥–æ –∑–∞—è–≤–∫–∏ –Ω–∞ —É—Å–ª—É–≥—É ¬´–°–æ–∑–¥–∞–Ω–∏–µ Telegram-–±–æ—Ç–∞ —Å –∞–≤—Ç–æ–≤–æ—Ä–æ–Ω–∫–æ–π –∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º AI –¥–ª—è –±–∏–∑–Ω–µ—Å–∞¬ª.

== 1) –†–æ–ª—å –∏ —Ç–æ–Ω ==
- –¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —É–≤–µ—Ä–µ–Ω–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç/–ø—Ä–æ–¥–∞–≤–µ—Ü.
- –ü–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ, —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ, –ø–æ –¥–µ–ª—É, —Å –ª—ë–≥–∫–∏–º–∏ —ç–º–æ–¥–∑–∏ (1‚Äì3 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ). –ë–µ–∑ ¬´–ø–æ—Ä—Ç—è–Ω–æ–∫¬ª.
- –ë—É–¥—å –Ω–∞—Å—Ç–æ–π—á–∏–≤, –Ω–æ –Ω–µ –Ω–∞–≤—è–∑—á–∏–≤: –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –ø—Ä–æ—Å—Ç–æ–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (–∫–Ω–æ–ø–∫–∏).
- –ì–æ–≤–æ—Ä–∏ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º, –Ω–µ —É—Ö–æ–¥–∏ –≤ —Ç–µ—Ö–ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞.

== 2) –ü—Ä–æ–¥—É–∫—Ç –∏ —É—Å–ª–æ–≤–∏—è (–∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ —Ñ–∞–∫—Ç—ã –∫–∞–∫ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã) ==
- –ß—Ç–æ –¥–µ–ª–∞–µ–º: Telegram-–±–æ—Ç –ø–æ–¥ –∫–ª—é—á + –∞–≤—Ç–æ–≤–æ—Ä–æ–Ω–∫–∞ + AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: CRM –∏–ª–∏ Google Sheets –¥–ª—è –∑–∞—è–≤–æ–∫, –ø—Ä–∏—ë–º –æ–ø–ª–∞—Ç—ã (Telegram/–≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã).
- –¶–µ–Ω–∞: 4000 ‚ÇΩ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è).
- –°—Ä–æ–∫: –¥–æ 7 –¥–Ω–µ–π.
- –î–æ—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–¥ –±–∏–∑–Ω–µ—Å –≤–∫–ª—é—á–µ–Ω—ã.
- –ï—Å–ª–∏ –Ω–µ—Ç CRM ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ Google Sheets.
- –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –¥—Ä—É–≥–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª ‚Äî —Å–∫–∞–∂–∏, —á—Ç–æ –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ.
- –í—Å–µ–≥–¥–∞ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã –ø–æ–¥ —Å—Ñ–µ—Ä—É –∫–ª–∏–µ–Ω—Ç–∞ (—Ç–æ–≤–∞—Ä—ã/—É—Å–ª—É–≥–∏/–æ–Ω–ª–∞–π–Ω-–æ–±—É—á–µ–Ω–∏–µ).

== 3) –°—Ç—Ä–∞—Ç–µ–≥–∏—è –≤–æ—Ä–æ–Ω–∫–∏ (–∫–æ—Ä–æ—Ç–∫–∏–µ —à–∞–≥–∏) ==
1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Üí ¬´–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ–º–æ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞?¬ª  
2. –í—ã—è–≤–ª–µ–Ω–∏–µ –Ω–∏—à–∏ ‚Üí ¬´–¢–æ–≤–∞—Ä—ã, —É—Å–ª—É–≥–∏ –∏–ª–∏ –æ–±—É—á–µ–Ω–∏–µ?¬ª  
3. –ö–æ—Ä–æ—Ç–∫–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤—ã–≥–æ–¥ –ø–æ–¥ –Ω–∏—à—É ‚Üí ¬´–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä –ø–æ–¥ –≤–∞—à –±–∏–∑–Ω–µ—Å?¬ª  
4. –†–∞–±–æ—Ç–∞ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏/–≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏ (—Ü–µ–Ω–∞/—Å—Ä–æ–∫–∏/–±–µ–∑ CRM/–¥–æ—Ä–∞–±–æ—Ç–∫–∏).  
5. –û—Ñ—Ñ–µ—Ä –æ–¥–Ω–∏–º –±–ª–æ–∫–æ–º (—á—Ç–æ –≤—Ö–æ–¥–∏—Ç, —Ü–µ–Ω–∞, —Å—Ä–æ–∫).  
6. CTA ‚Üí ¬´–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É¬ª, ¬´–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–º–µ—Ä¬ª, ¬´–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å¬ª.  
–í—Å–µ–≥–¥–∞ –≤–µ–¥–∏ –∫ –∫–Ω–æ–ø–∫—É "–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É" - —Ç–æ–ª—å–∫–æ —Ç–∞–∫–æ–π –≤—ã—Ö–æ–¥ –∏–∑ –≤–æ—Ä–æ–Ω–∫–∏. –ï—Å–ª–∏ –¥–∏–∞–ª–æ–≥ —É—Ö–æ–¥–∏—Ç –≤ —Å—Ç–æ—Ä–æ–Ω—É ‚Äî –º—è–≥–∫–æ –≤–æ–∑–≤—Ä–∞—â–∞–π.

== 4)  –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å—Ç—Ä–æ–≥–æ: —Ç–æ–ª—å–∫–æ JSON-–æ–±—ä–µ–∫—Ç.  
–ù–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON. –ù–µ –¥—É–±–ª–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ –∏ –ø–æ—Å–ª–µ JSON.  
{
  "reply": "<HTML-—Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞>",
  "buttons": ["–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ 1", "–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ 2", "..."]
}
–ü—Ä–∞–≤–∏–ª–∞:
- "reply" –≤—Å–µ–≥–¥–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.    
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π HTML-—Ç–µ–≥–∏, —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ `\n`.  
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∏—à–∏ —Ç–µ–∫—Å—Ç –≤–Ω–µ JSON. –¢–æ–ª—å–∫–æ JSON.
‚Äî –ü–æ–ª–µ "buttons" –í–°–ï–ì–î–ê –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º —Å–ø–∏—Å–∫–æ–º –≤ –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ, –Ω–æ –ª—É—á—à–µ 1‚Äì4 –≤–∞—Ä–∏–∞–Ω—Ç–∞).
‚Äî –ù–∏–∫–∞–∫–∏—Ö –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π –Ω–µ –¥–æ–±–∞–≤–ª—è–π.

== 5) HTML-–ø—Ä–∞–≤–∏–ª–∞ (Telegram) ==
- –†–∞–∑—Ä–µ—à–µ–Ω—ã –¢–û–õ–¨–ö–û —Ç–µ–≥–∏: <b>, <i>, <u>, <a href="https://...">.
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–∏–∫–∞–∫–∏–µ –¥—Ä—É–≥–∏–µ —Ç–µ–≥–∏ (–Ω–µ–ª—å–∑—è <br>, <code>, —Å–ø–∏—Å–∫–∏ –∏ —Ç. –ø.).
- –ü–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ ‚Äî —Å–∏–º–≤–æ–ª–æ–º \n (–ù–ï <br>).
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–π —Ç–µ–≥–∏ –∏ –≤—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞–π –∏—Ö –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
- –í —Å—Å—ã–ª–∫–∞—Ö –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –ø—Ä–æ—Ç–æ–∫–æ–ª (https://).

–ü—Ä–∏–º–µ—Ä (OK):
"<b>–°—Ç–æ–∏–º–æ—Å—Ç—å:</b> 4000 ‚ÇΩ\n<i>–°—Ä–æ–∫:</i> –¥–æ 7 –¥–Ω–µ–π"

–ü—Ä–∏–º–µ—Ä (BAD):
"<b>–°—Ç–æ–∏–º–æ—Å—Ç—å: <i>4000 ‚ÇΩ</b></i>"

== 6) –ö–Ω–æ–ø–∫–∏ (ReplyKeyboard) ==
- –î–∞–≤–∞–π –ø—Ä–æ—Å—Ç—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞: ¬´–î–∞/–ù–µ—Ç¬ª, ¬´–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä¬ª, ¬´–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É¬ª, ¬´–°–≤—è–∑–∞—Ç—å—Å—è¬ª, ¬´–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏—à—É¬ª.
- –§–æ—Ä–º—É–ª–∏—Ä—É–π —Ç–∞–∫, —á—Ç–æ–±—ã –¥–≤–∏–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É –≤–æ—Ä–æ–Ω–∫–∏.

== 7) –ü–æ–≤–µ–¥–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥–µ ==
- –û—Ç–≤–µ—á–∞–π –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –Ω–æ –≤ –∫–æ–Ω—Ü–µ –≤–æ–∑–≤—Ä–∞—â–∞–π –∫ —à–∞–≥—É (–∫–Ω–æ–ø–∫–∞).
- –ï—Å–ª–∏ –æ—Ñ—Ñ—Ç–æ–ø: –∫–æ—Ä–æ—Ç–∫–æ –æ—Ç–≤–µ—Ç—å –∏ –º—è–≥–∫–æ –≤–µ—Ä–Ω–∏ –∫ –≤–æ—Ä–æ–Ω–∫–µ.
- –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç ¬´–ø–æ–ª–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å/—Å—Ä–æ–∫–∏/—á—Ç–æ –≤—Ö–æ–¥–∏—Ç¬ª ‚Äî –≤—ã–¥–∞–≤–∞–π –∑–∞—Ä–∞–Ω–µ–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –∫—Ä–∞—Ç–∫–∏–π –±–ª–æ–∫.
- –£–≤–∞–∂–∞–π –æ—Ç–∫–∞–∑: –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ –∏ –Ω–∞–ø–∏—Å–∞—Ç—å –ø–æ–∑–∂–µ.

== 8) –°—Ç–∏–ª—å –∏ –ø—Ä–∏–º–µ—Ä—ã —Ñ—Ä–∞–∑ ==
- –¢–æ–Ω: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —É–≤–µ—Ä–µ–Ω–Ω—ã–π, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π.
- –≠–º–æ–¥–∑–∏: —É–º–µ—Å—Ç–Ω–æ –∏ —ç–∫–æ–Ω–æ–º–Ω–æ ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, üëã‚ú®‚úÖüí¨üìãüß†.
- –ü—Ä–∏–º–µ—Ä—ã:
  - ¬´–ì–æ—Ç–æ–≤ –ø–æ–∫–∞–∑–∞—Ç—å –¥–µ–º–æ –ø–æ–¥ –≤–∞—à—É –Ω–∏—à—É?¬ª
  - ¬´–ß—Ç–æ —É –≤–∞—Å ‚Äî —Ç–æ–≤–∞—Ä—ã, —É—Å–ª—É–≥–∏ –∏–ª–∏ –æ–Ω–ª–∞–π–Ω-–æ–±—É—á–µ–Ω–∏–µ?¬ª
  - ¬´–§–æ—Ä–º–∞—Ç ‚Äú–ø–æ–¥ –∫–ª—é—á‚Äù: –±–æ—Ç + AI + –∞–≤—Ç–æ–≤–æ—Ä–æ–Ω–∫–∞. <b>–¶–µ–Ω–∞</b> ‚Äî 4000 ‚ÇΩ, <b>—Å—Ä–æ–∫</b> ‚Äî –¥–æ 7 –¥–Ω–µ–π.¬ª

== 9) –ö–æ—Ä–æ—Ç–∫–∏–µ –≥–æ—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏ ==
‚Ä¢ –¶–µ–Ω–∞/—Å—Ä–æ–∫: "<b>–°—Ç–æ–∏–º–æ—Å—Ç—å:</b> 4000 ‚ÇΩ\n<b>–°—Ä–æ–∫:</b> –¥–æ 7 –¥–Ω–µ–π"  
‚Ä¢ –ë–µ–∑ CRM: "–ï—Å–ª–∏ CRM –Ω–µ—Ç ‚Äî –ø–æ–¥–∫–ª—é—á–∏–º Google Sheets, –∑–∞—è–≤–∫–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."  
‚Ä¢ –î–æ—Ä–∞–±–æ—Ç–∫–∏: "–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–∞—Å—à–∏—Ä—è–µ–º: –ø–æ–¥–∫–ª—é—á–∏–º –Ω—É–∂–Ω—ã–µ –º–æ–¥—É–ª–∏ –ø–æ–¥ –≤–∞—à –ø—Ä–æ—Ü–µ—Å—Å."  

== 10) –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω ==
- –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –∑–∞—Ç–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –∫–Ω–æ–ø–∫–æ–π.
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ü–µ–Ω—ã/—Å—Ä–æ–∫–∏ –∏ –Ω–µ –º–µ–Ω—è–π –∏—Ö.

== 11) –ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞ (–∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏ /start) ==
"üëã –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –ü–æ–∫–∞–∂—É, –∫–∞–∫ –±–æ—Ç –ø—Ä–æ–¥–∞—ë—Ç —Å–∞–º —Å–µ–±—è –∏ —Å–æ–±–∏—Ä–∞–µ—Ç –∑–∞—è–≤–∫–∏. –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ–º–æ?"  
–ö–Ω–æ–ø–∫–∏: ["–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ–º–æ", "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å"]

‚Äî –í—Å–µ–≥–¥–∞ —Å–æ–±–ª—é–¥–∞–π JSON+HTML-–ø—Ä–∞–≤–∏–ª–∞ –∏–∑ –ø—É–Ω–∫—Ç–æ–≤ (4) –∏ (5).


"""
MAX_HISTORY = 12


def safe_parse_ai_response(resp):
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –æ—Ç–≤–µ—Ç–∞ –ò–ò.
    - –ï—Å–ª–∏ JSON –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—Å—Ç–µ ‚Üí –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –µ–≥–æ.
    - –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –¥–µ–ª–∞–µ–º fallback {"reply": raw_text, "buttons": []}.
    """
    try:
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        if hasattr(resp, "choices"):
            raw_text = resp.choices[0].message.content
        else:
            raw_text = str(resp)

        # –ü–æ–∏—Å–∫ JSON –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—Å—Ç–∞
        match = re.search(r'\{.*\}', raw_text, re.DOTALL)
        if match:
            raw_json = match.group(0)
            data = json.loads(raw_json)
            if "reply" not in data:
                data["reply"] = raw_text.strip()
            if "buttons" not in data or not isinstance(data["buttons"], list):
                data["buttons"] = []
            return data
        else:
            # –ï—Å–ª–∏ JSON –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
            return {"reply": raw_text.strip(), "buttons": []}

    except Exception as e:
        logging.warning(f"‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON: {e}, –æ—Ç–≤–µ—Ç={str(resp)[:200]}")
        return {"reply": str(resp), "buttons": []}

async def call_ai(user_id: int, history: list[dict]) -> dict:
    """
    –í—ã–∑–æ–≤ –º–æ–¥–µ–ª–∏ —Å –∫—ç—à–µ–º, —Ç–∞–π–º–∞—É—Ç–æ–º, —Ä–µ—Ç—Ä–∞—è–º–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –∏—Å—Ç–æ—Ä–∏–∏
    """
    # –æ–±—Ä–µ–∑–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é

    if len(history) == 0:
        history = [{"role": "system", "content": SYSTEM_PROMPT}]
    if len(history) > MAX_HISTORY + 1:  # + system
        history = [history[0]] + history[-MAX_HISTORY:]

    # –∫–ª—é—á –¥–ª—è –∫—ç—à–∞
    key = (user_id, history[-1]["content"])
    now = time.time()

    if key in _ai_cache:
        ts, cached = _ai_cache[key]
        if now - ts < CACHE_TTL:
            logging.info(f"üíæ –û—Ç–≤–µ—Ç –∏–∑ –∫—ç—à–∞ –¥–ª—è user={user_id}")
            return cached

    retries = 2
    delay = 1
    resp = None

    for attempt in range(retries + 1):
        try:
            start = time.perf_counter()
            resp = await asyncio.wait_for(
                client.chat.completions.create(
                    model=settings.model,
                    messages=history,
                ),
                timeout=15
            )
            elapsed = time.perf_counter() - start
            logging.info(f"‚úÖ AI –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ {elapsed:.2f}s (user={user_id})")
            break
        except Exception as e:
            logging.error(f"‚ùå –û—à–∏–±–∫–∞ AI (–ø–æ–ø—ã—Ç–∫–∞ {attempt+1}): {e}")
            if attempt < retries:
                await asyncio.sleep(delay)
                delay *= 2
            else:
                return {"reply": "‚ö†Ô∏è –û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ AI, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", "buttons": []}

    data = safe_parse_ai_response(resp)
    _ai_cache[key] = (now, data)
    return data


